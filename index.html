<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد الإيرادات | ملخص</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- For CSV parsing (optional) -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- For Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: #F5F7FA; 
        }
        .card { 
            background-color: white; 
            border-radius: 12px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.02); 
            transition: transform 0.2s, box-shadow 0.2s; 
        }
        .card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
        }
        .page { display: none; }
        .page.active { display: block; }
        .nav-item { transition: all 0.2s; }
        .nav-item.active { 
            background-color: #1E40AF; 
            color: white; 
        }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .loading-spinner {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.9);
            z-index: 10;
        }
        .toast {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .sort-asc::after {
            content: ' ▲';
            font-size: 10px;
        }
        .sort-desc::after {
            content: ' ▼';
            font-size: 10px;
        }
        
        /* ============================================
           THEME STYLES
           ============================================ */
        
        /* Light Theme (Default) */
        [data-theme="light"] {
            --bg-primary: #FFFFFF;
            --bg-card: #FFFFFF;
            --bg-sidebar: #1E40AF;
            --bg-header: #FFFFFF;
            --bg-input: #F8F9FA;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --border-color: #E5E7EB;
            --border-sidebar: #1E40AF;
            --nav-active: #1E40AF;
            --nav-hover: #F3F4F6;
            --scrollbar-track: #f1f1f1;
            --scrollbar-thumb: #cbd5e1;
        }
        
        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: #0F172A;
            --bg-card: #1E293B;
            --bg-sidebar: #1E293B;
            --bg-header: #1E293B;
            --bg-input: #334155;
            --text-primary: #F1F5F9;
            --text-secondary: #CBD5E1;
            --text-muted: #94a3b8;
            --border-color: #475569;
            --border-sidebar: #475569;
            --nav-active: #3B82F6;
            --nav-hover: #334155;
            --scrollbar-track: #1E293B;
            --scrollbar-thumb: #475569;
        }
        
        /* Mono Theme */
        [data-theme="mono"] {
            --bg-primary: #F0FDFA;
            --bg-card: #FFFFFF;
            --bg-sidebar: #0F766E;
            --bg-header: #FFFFFF;
            --bg-input: #F0FDFA;
            --text-primary: #134e4a;
            --text-secondary: #0f766e;
            --text-muted: #14b8a6;
            --border-color: #14b8a6;
            --border-sidebar: #0F766E;
            --nav-active: #0f766e;
            --nav-hover: #E6FFFA;
            --scrollbar-track: #f1f1f1;
            --scrollbar-thumb: #14b8a6;
        }
        
        /* Apply theme variables */
        [data-theme="light"] body,
        [data-theme="dark"] body,
        [data-theme="mono"] body {
            background-color: var(--bg-primary);
        }
        
        /* Main content area background */
        [data-theme="dark"] main {
            background-color: var(--bg-primary) !important;
        }
        
        [data-theme="dark"] main > div.flex-1 {
            background-color: var(--bg-primary) !important;
        }
        
        [data-theme="dark"] .flex-1.overflow-y-auto {
            background-color: var(--bg-primary) !important;
        }
        
        [data-theme="light"] .card,
        [data-theme="dark"] .card,
        [data-theme="mono"] .card {
            background-color: var(--bg-card);
        }
        
        [data-theme="light"] .card {
            border: 1px solid #E5E7EB !important;
        }
        
        [data-theme="dark"] .card {
            border: 1px solid var(--border-color);
        }
        
        [data-theme="mono"] .card {
            border: 1px solid var(--border-color);
        }
        
        /* KPI Cards with light gray background in light theme */
        [data-theme="light"] .card.border-r-4 {
            background-color: #F9FAFB !important;
            border: 1px solid #E5E7EB !important;
        }
        
        [data-theme="light"] .card.p-4.flex.items-center.justify-between {
            background-color: #F9FAFB !important;
            border: 1px solid #E5E7EB !important;
        }
        
        [data-theme="dark"] .card:hover {
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        
        [data-theme="mono"] .card:hover {
            box-shadow: 0 4px 12px rgba(20, 184, 166, 0.15);
        }
        
        [data-theme="dark"] .nav-item.active {
            background-color: var(--nav-active);
        }
        
        [data-theme="mono"] .nav-item.active {
            background-color: var(--nav-active);
        }
        
        [data-theme="dark"] ::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
        }
        
        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
        }
        
        [data-theme="mono"] ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
        }
        
        [data-theme="dark"] .loading-spinner {
            background: rgba(15, 23, 42, 0.9);
        }
        
        /* Sidebar Styles */
        [data-theme="light"] aside {
            background-color: var(--bg-sidebar) !important;
            border-color: var(--border-sidebar) !important;
        }
        
        [data-theme="light"] aside .text-blue-900 {
            color: white !important;
        }
        
        [data-theme="light"] aside .nav-item:not(.active) {
            color: rgba(255, 255, 255, 0.8) !important;
        }
        
        [data-theme="light"] aside .nav-item:not(.active):hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
            color: white !important;
        }
        
        [data-theme="light"] aside .border-b,
        [data-theme="light"] aside .border-t {
            border-color: rgba(255, 255, 255, 0.2) !important;
        }
        
        [data-theme="dark"] aside {
            background-color: var(--bg-sidebar) !important;
            border-color: var(--border-sidebar) !important;
        }
        
        [data-theme="mono"] aside {
            background-color: var(--bg-sidebar) !important;
            border-color: var(--border-sidebar) !important;
        }
        
        [data-theme="mono"] aside .text-blue-900 {
            color: white !important;
        }
        
        [data-theme="mono"] aside .nav-item:not(.active) {
            color: rgba(255, 255, 255, 0.8) !important;
        }
        
        [data-theme="mono"] aside .nav-item:not(.active):hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
            color: white !important;
        }
        
        [data-theme="mono"] aside .border-b,
        [data-theme="mono"] aside .border-t {
            border-color: rgba(255, 255, 255, 0.2) !important;
        }
        
        [data-theme="dark"] aside .border-b,
        [data-theme="dark"] aside .border-t {
            border-color: var(--border-sidebar) !important;
        }
        
        [data-theme="mono"] aside .border-b,
        [data-theme="mono"] aside .border-t {
            border-color: var(--border-sidebar) !important;
        }
        
        [data-theme="dark"] .nav-item:not(.active) {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="dark"] .nav-item:not(.active):hover {
            background-color: var(--nav-hover) !important;
            color: var(--text-primary) !important;
        }
        
        [data-theme="mono"] .nav-item:not(.active) {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="mono"] .nav-item:not(.active):hover {
            background-color: var(--nav-hover) !important;
            color: var(--text-primary) !important;
        }
        
        /* Header Styles */
        [data-theme="dark"] header {
            background-color: var(--bg-header) !important;
            border-color: var(--border-color) !important;
        }
        
        [data-theme="mono"] header {
            background-color: var(--bg-header) !important;
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] header h1,
        [data-theme="dark"] header button {
            color: var(--text-primary) !important;
        }
        
        [data-theme="mono"] header h1,
        [data-theme="mono"] header button {
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] header button:hover {
            background-color: var(--nav-hover) !important;
        }
        
        [data-theme="mono"] header button:hover {
            background-color: var(--nav-hover) !important;
        }
        
        /* Filter and Input Styles */
        [data-theme="dark"] .bg-white {
            background-color: var(--bg-card) !important;
        }
        
        [data-theme="dark"] select,
        [data-theme="dark"] input {
            background-color: #1e293b !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }
        
        [data-theme="mono"] select,
        [data-theme="mono"] input {
            background-color: var(--bg-input) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }
        
        /* Text Colors */
        [data-theme="dark"] .text-gray-800,
        [data-theme="dark"] .text-gray-900 {
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .text-gray-500,
        [data-theme="dark"] .text-gray-600,
        [data-theme="dark"] .text-gray-700 {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="mono"] .text-gray-800,
        [data-theme="mono"] .text-gray-900 {
            color: var(--text-primary) !important;
        }
        
        [data-theme="mono"] .text-gray-500,
        [data-theme="mono"] .text-gray-600,
        [data-theme="mono"] .text-gray-700 {
            color: var(--text-secondary) !important;
        }
        
        /* Table Styles */
        [data-theme="dark"] thead {
            background-color: #1e293b !important;
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] tbody tr {
            background-color: var(--bg-card) !important;
            border-color: var(--border-color) !important;
            color: var(--text-secondary) !important;
        }
        
        [data-theme="dark"] tbody tr:hover {
            background-color: var(--nav-hover) !important;
        }
        
        [data-theme="mono"] thead {
            background-color: var(--bg-input) !important;
            color: var(--text-primary) !important;
        }
        
        [data-theme="mono"] tbody tr:hover {
            background-color: var(--nav-hover) !important;
        }
        
        /* Button Styles */
        [data-theme="dark"] .bg-blue-900 {
            background-color: #3B82F6 !important;
        }
        
        [data-theme="dark"] .bg-blue-900:hover {
            background-color: #2563EB !important;
        }
        
        [data-theme="mono"] .bg-blue-900 {
            background-color: var(--nav-active) !important;
        }
        
        [data-theme="mono"] .bg-blue-900:hover {
            background-color: #0d9488 !important;
        }
        
        /* Additional theme overrides */
        [data-theme="dark"] .bg-gray-50,
        [data-theme="dark"] .bg-gray-100 {
            background-color: #1e293b !important;
        }
        
        [data-theme="dark"] .border-gray-200,
        [data-theme="dark"] .border-gray-100 {
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] .hover\:bg-gray-50:hover,
        [data-theme="dark"] .hover\:bg-gray-100:hover {
            background-color: var(--nav-hover) !important;
        }
        
        [data-theme="mono"] .border-gray-200,
        [data-theme="mono"] .border-gray-100 {
            border-color: var(--border-color) !important;
        }
        
        [data-theme="mono"] .hover\:bg-gray-50:hover {
            background-color: var(--nav-hover) !important;
        }
        
        [data-theme="dark"] .text-blue-900 {
            color: var(--text-primary) !important;
        }
        
        [data-theme="mono"] .text-blue-900 {
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .bg-blue-50 {
            background-color: rgba(59, 130, 246, 0.1) !important;
        }
        
        [data-theme="dark"] .text-blue-600 {
            color: #60a5fa !important;
        }
        
        [data-theme="mono"] .bg-blue-50 {
            background-color: var(--bg-input) !important;
        }
        
        [data-theme="mono"] .text-blue-600 {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="dark"] .text-green-600 {
            color: #10b981 !important;
        }
        
        [data-theme="mono"] .text-green-600 {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="dark"] .bg-blue-100 {
            background-color: rgba(59, 130, 246, 0.2) !important;
        }
        
        [data-theme="dark"] .text-blue-700 {
            color: #93c5fd !important;
        }
        
        [data-theme="dark"] .border-blue-200 {
            border-color: rgba(59, 130, 246, 0.3) !important;
        }
        
        [data-theme="mono"] .bg-blue-100 {
            background-color: var(--bg-input) !important;
        }
        
        [data-theme="mono"] .text-blue-700 {
            color: var(--text-primary) !important;
        }
        
        [data-theme="mono"] .border-blue-200 {
            border-color: var(--border-color) !important;
        }
        
        /* Theme Dropdown Styles */
        #themeDropdownMenu {
            min-width: 160px;
        }
        
        /* Unified theme option styles for all themes */
        .theme-option {
            color: #1f2937 !important;
            background-color: transparent !important;
            border: none !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        }
        
        .theme-option:hover {
            background-color: #f3f4f6 !important;
            color: #111827 !important;
        }
        
        .theme-option .theme-check {
            color: #2563EB !important;
        }
        
        /* Dark theme dropdown */
        [data-theme="dark"] #themeDropdownMenu {
            background-color: #1E293B !important;
            border-color: #475569 !important;
        }
        
        [data-theme="dark"] .theme-option {
            color: #F1F5F9 !important;
            background-color: transparent !important;
        }
        
        [data-theme="dark"] .theme-option:hover {
            background-color: #334155 !important;
            color: #FFFFFF !important;
        }
        
        [data-theme="dark"] .theme-option .theme-check {
            color: #60A5FA !important;
        }
        
        /* Mono theme dropdown */
        [data-theme="mono"] #themeDropdownMenu {
            background-color: white !important;
            border-color: #14b8a6 !important;
        }
        
        [data-theme="mono"] .theme-option {
            color: #134e4a !important;
            background-color: transparent !important;
        }
        
        [data-theme="mono"] .theme-option:hover {
            background-color: #E6FFFA !important;
            color: #0f766e !important;
        }
        
        [data-theme="mono"] .theme-option .theme-check {
            color: #0f766e !important;
        }
        
        /* Checkbox styles for comparison years */
        [data-theme="dark"] input[type="checkbox"] {
            background-color: #334155 !important;
            border-color: #475569 !important;
        }
        
        [data-theme="dark"] input[type="checkbox"]:checked {
            background-color: #3B82F6 !important;
            border-color: #3B82F6 !important;
        }
        
        [data-theme="dark"] label span {
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] label:hover {
            background-color: #334155 !important;
        }
        
        [data-theme="mono"] input[type="checkbox"] {
            background-color: white !important;
            border-color: var(--border-color) !important;
        }
        
        [data-theme="mono"] input[type="checkbox"]:checked {
            background-color: var(--nav-active) !important;
            border-color: var(--nav-active) !important;
        }
        
        [data-theme="mono"] label span {
            color: var(--text-primary) !important;
        }
        
        [data-theme="mono"] label:hover {
            background-color: var(--nav-hover) !important;
        }
    </style>
</head>
<body class="text-gray-800" data-theme="light">

    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="hidden lg:flex flex-col w-64 bg-white border-l border-gray-200 h-screen sticky top-0 z-20">
            <div class="p-6 flex items-center justify-center border-b border-gray-100">
                <div class="text-2xl font-bold text-blue-900 flex items-center gap-2">
                    <i class="ph ph-chart-polar"></i>
                    <span>إيراداتي</span>
                </div>
            </div>

            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <a href="#" onclick="showPage('overview'); return false;" class="nav-item active flex items-center gap-3 p-3 text-white bg-blue-900 rounded-lg font-bold">
                    <i class="ph ph-squares-four text-xl"></i>
                    ملخص الإيرادات
                </a>
                <a href="#" onclick="showPage('accounts'); return false;" class="nav-item flex items-center gap-3 p-3 text-gray-500 hover:bg-gray-50 hover:text-blue-900 rounded-lg transition">
                    <i class="ph ph-bank text-xl"></i>
                    تحليل الحسابات
                </a>
                <a href="#" onclick="showPage('tabs'); return false;" class="nav-item flex items-center gap-3 p-3 text-gray-500 hover:bg-gray-50 hover:text-blue-900 rounded-lg transition">
                    <i class="ph ph-tag text-xl"></i>
                    تحليل التبويب
                </a>
                <a href="#" onclick="showPage('comparison'); return false;" class="nav-item flex items-center gap-3 p-3 text-gray-500 hover:bg-gray-50 hover:text-blue-900 rounded-lg transition">
                    <i class="ph ph-trend-up text-xl"></i>
                    مقارنة السنوات
                </a>
                <a href="#" onclick="showPage('details'); return false;" class="nav-item flex items-center gap-3 p-3 text-gray-500 hover:bg-gray-50 hover:text-blue-900 rounded-lg transition">
                    <i class="ph ph-table text-xl"></i>
                    الجدول التفصيلي
                </a>
            </nav>

            <div class="p-4 border-t border-gray-100">
                <a href="#" class="flex items-center gap-3 p-3 text-red-500 hover:bg-red-50 rounded-lg transition">
                    <i class="ph ph-sign-out text-xl"></i>
                    تسجيل خروج
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col min-w-0 overflow-hidden">
            <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-4 lg:px-8">
                <div class="flex items-center gap-4">
                    <button id="mobileMenuBtn" class="lg:hidden p-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                        <i class="ph ph-list text-2xl"></i>
                    </button>
                    <h1 id="pageTitle" class="text-xl font-bold text-gray-800">ملخص الإيرادات</h1>
                </div>

                <div class="flex items-center gap-4">
                    <button id="refreshBtn" class="p-2 text-gray-500 hover:bg-gray-100 rounded-full transition" title="تحديث البيانات">
                        <i class="ph ph-arrow-clockwise text-xl"></i>
                    </button>
                    <div class="hidden md:flex items-center bg-gray-100 rounded-lg px-3 py-2">
                        <i class="ph ph-magnifying-glass text-gray-400 ml-2"></i>
                        <input type="text" id="globalSearch" placeholder="بحث..." class="bg-transparent border-none outline-none text-sm w-48">
                    </div>
                    <div class="relative" id="themeDropdownContainer">
                        <button id="themeToggleBtn" class="p-2 text-gray-500 hover:bg-gray-100 rounded-full transition flex items-center gap-2" title="تبديل الثيم">
                            <i class="ph ph-palette text-xl"></i>
                            <span class="hidden md:inline text-sm" id="themeCurrentLabel">فاتح</span>
                            <i class="ph ph-caret-down text-xs"></i>
                        </button>
                        <div id="themeDropdownMenu" class="hidden absolute left-0 top-full mt-2 w-40 bg-white rounded-lg shadow-lg border border-gray-200 z-50 overflow-hidden">
                            <button class="theme-option w-full text-right px-4 py-2 transition flex items-center justify-between" data-theme="light">
                                <span class="font-medium">فاتح</span>
                                <i class="ph ph-check hidden theme-check"></i>
                            </button>
                            <button class="theme-option w-full text-right px-4 py-2 transition flex items-center justify-between" data-theme="dark">
                                <span class="font-medium">داكن</span>
                                <i class="ph ph-check hidden theme-check"></i>
                            </button>
                            <button class="theme-option w-full text-right px-4 py-2 transition flex items-center justify-between" data-theme="mono">
                                <span class="font-medium">أحادي</span>
                                <i class="ph ph-check hidden theme-check"></i>
                            </button>
                        </div>
                    </div>
                    <button class="p-2 text-gray-500 hover:bg-gray-100 rounded-full relative">
                        <i class="ph ph-bell text-xl"></i>
                        <span class="absolute top-2 left-2 w-2 h-2 bg-red-500 rounded-full border border-white"></span>
                    </button>
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-700 font-bold border border-blue-200">
                        م
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-4 lg:p-8" style="background-color: var(--bg-primary);">
                
                <!-- Page 1: Overview -->
                <div id="overview" class="page active">
                    <!-- Filters -->
                    <div class="bg-white p-4 rounded-xl shadow-sm mb-6 flex flex-col md:flex-row gap-4 items-center justify-between">
                        <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                            <div class="relative w-full md:w-auto">
                                <select id="filterYear" class="w-full md:w-48 bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block px-4 py-2.5 outline-none">
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                </select>
                            </div>
                            <div class="relative w-full md:w-auto">
                                <select id="filterMonthRange" class="w-full md:w-48 bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block px-4 py-2.5 outline-none">
                                    <option value="all">جميع الأشهر</option>
                                    <option value="1-6">يناير - يونيو</option>
                                    <option value="7-12">يوليو - ديسمبر</option>
                                </select>
                            </div>
                            <div class="relative w-full md:w-auto">
                                <select id="filterAccount" class="w-full md:w-48 bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block px-4 py-2.5 outline-none">
                                    <option value="all">جميع حسابات الإيراد</option>
                                    <option value="استشارات">استشارات</option>
                                    <option value="مبيعات">مبيعات</option>
                                    <option value="خدمات">خدمات</option>
                                </select>
                            </div>
                        </div>
                        <button id="applyFiltersBtn" class="w-full md:w-auto bg-blue-900 hover:bg-blue-800 text-white font-medium rounded-lg text-sm px-5 py-2.5 transition text-center flex items-center justify-center gap-2">
                            <i class="ph ph-funnel"></i>
                            تطبيق الفلاتر
                        </button>
                    </div>

                    <!-- KPI Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="card p-4 border-r-4 border-blue-500">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-gray-500 text-sm font-medium">إجمالي المفوتر</h3>
                                <span class="p-1.5 rounded bg-blue-50 text-blue-600"><i class="ph ph-receipt text-lg"></i></span>
                            </div>
                            <div class="text-2xl font-bold text-gray-800 mb-1"><span id="kpi-invoiced">540,200</span> <span class="text-sm font-normal text-gray-500">ر.س</span></div>
                            <div class="flex items-center text-xs text-green-600 font-medium">
                                <i class="ph ph-trend-up mr-1"></i>
                                <span>+12% عن الشهر الماضي</span>
                            </div>
                        </div>

                        <div class="card p-4 border-r-4 border-green-500 relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-16 h-16 bg-green-50 rounded-br-full -mt-2 -ml-2 opacity-50"></div>
                            <div class="flex justify-between items-start mb-2 relative z-10">
                                <h3 class="text-gray-500 text-sm font-medium">إجمالي المحصل</h3>
                                <span class="p-1.5 rounded bg-green-50 text-green-600"><i class="ph ph-coins text-lg"></i></span>
                            </div>
                            <div class="text-2xl font-bold text-gray-900 mb-1 relative z-10"><span id="kpi-collected">480,500</span> <span class="text-sm font-normal text-gray-500">ر.س</span></div>
                            <div class="flex items-center text-xs text-green-600 font-medium relative z-10">
                                <i class="ph ph-check-circle mr-1"></i>
                                <span>أداء ممتاز</span>
                            </div>
                        </div>

                        <div class="card p-4 border-r-4 border-orange-400">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-gray-500 text-sm font-medium">الفجوة (غير محصل)</h3>
                                <span class="p-1.5 rounded bg-orange-50 text-orange-600"><i class="ph ph-warning-circle text-lg"></i></span>
                            </div>
                            <div class="text-2xl font-bold text-gray-800 mb-1"><span id="kpi-gap">59,700</span> <span class="text-sm font-normal text-gray-500">ر.س</span></div>
                            <div class="flex items-center text-xs text-gray-500">
                                <span>تمثل 11% من المفوتر</span>
                            </div>
                        </div>

                        <div class="card p-4 border-r-4 border-purple-500">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-gray-500 text-sm font-medium">نسبة التحصيل</h3>
                                <span class="p-1.5 rounded bg-purple-50 text-purple-600"><i class="ph ph-percent text-lg"></i></span>
                            </div>
                            <div class="text-2xl font-bold text-gray-800 mb-1"><span id="kpi-collection-rate">89</span>%</div>
                            <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2">
                                <div id="collection-rate-progress" class="bg-purple-500 h-1.5 rounded-full" style="width: 89%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional KPI Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-6">
                        <div class="card p-4 flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-xs mb-1">المستهدف السنوي</p>
                                <p class="font-bold text-lg"><span id="kpi-target">1,200,000</span> <span class="text-xs text-gray-400">ر.س</span></p>
                            </div>
                            <div class="h-10 w-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500">
                                <i class="ph ph-target text-xl"></i>
                            </div>
                        </div>
                        <div class="card p-4 flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-xs mb-1">نسبة تحقيق المستهدف</p>
                                <p class="font-bold text-lg text-blue-700"><span id="kpi-target-achievement">40</span>%</p>
                            </div>
                            <div class="h-10 w-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
                                <i class="ph ph-chart-pie-slice text-xl"></i>
                            </div>
                        </div>
                        <div class="card p-4 flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-xs mb-1">النمو السنوي (YoY)</p>
                                <p class="font-bold text-lg text-green-600">+<span id="kpi-growth">15</span>% <i class="ph ph-caret-up text-sm"></i></p>
                            </div>
                            <div class="h-10 w-10 rounded-full bg-green-50 flex items-center justify-center text-green-600">
                                <i class="ph ph-chart-line-up text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Grid - Consistent Layout -->
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-6">
                        <!-- Chart 1: Monthly Performance -->
                        <div class="card p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-gray-800 text-sm">الأداء الشهري: المفوتر vs المحصل</h3>
                                <button class="text-gray-400 hover:text-blue-900"><i class="ph ph-dots-three-outline text-lg"></i></button>
                            </div>
                            <div class="relative h-64 w-full flex items-center justify-center">
                                <canvas id="mainChart"></canvas>
                            </div>
                        </div>

                        <!-- Chart 2: Target Achievement -->
                        <div class="card p-4 flex flex-col">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-gray-800 text-sm text-right">تحقيق المستهدف</h3>
                                <button class="text-gray-400 hover:text-blue-900"><i class="ph ph-dots-three-outline text-lg"></i></button>
                            </div>
                            <div class="relative h-48 w-full flex items-center justify-center">
                                <canvas id="targetChart"></canvas>
                                <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                    <span class="text-3xl font-bold text-gray-800">40%</span>
                                    <span class="text-xs text-gray-500">من الهدف السنوي</span>
                                </div>
                            </div>
                            <div class="mt-3 w-full">
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-gray-500">المحصل: 480k</span>
                                    <span class="text-gray-500">الهدف: 1.2M</span>
                                </div>
                                <div class="w-full bg-gray-100 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: 40%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Chart 3: Accounts Comparison -->
                        <div class="card p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-gray-800 text-sm">مقارنة الحسابات</h3>
                                <button class="text-gray-400 hover:text-blue-900"><i class="ph ph-dots-three-outline text-lg"></i></button>
                            </div>
                            <div class="relative h-64 w-full flex items-center justify-center">
                                <canvas id="accountsComparisonChart"></canvas>
                            </div>
                        </div>

                        <!-- Chart 4: Accounts Distribution -->
                        <div class="card p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-gray-800 text-sm">توزيع الإيراد حسب الحساب</h3>
                                <button class="text-gray-400 hover:text-blue-900"><i class="ph ph-dots-three-outline text-lg"></i></button>
                            </div>
                            <div class="relative h-64 w-full flex items-center justify-center">
                                <canvas id="accountsDistributionChart"></canvas>
                            </div>
                        </div>

                        <!-- Chart 5: Collection Rate Trend -->
                        <div class="card p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-gray-800 text-sm">اتجاه نسبة التحصيل</h3>
                                <button class="text-gray-400 hover:text-blue-900"><i class="ph ph-dots-three-outline text-lg"></i></button>
                            </div>
                            <div class="relative h-64 w-full flex items-center justify-center">
                                <canvas id="collectionRateChart"></canvas>
                            </div>
                        </div>

                        <!-- Chart 6: Stacked Monthly -->
                        <div class="card p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-gray-800 text-sm">الإيراد الشهري (مكدس)</h3>
                                <button class="text-gray-400 hover:text-blue-900"><i class="ph ph-dots-three-outline text-lg"></i></button>
                            </div>
                            <div class="relative h-64 w-full flex items-center justify-center">
                                <canvas id="stackedMonthlyChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Year Comparison Table -->
                    <div class="card p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-800 text-sm">مقارنة سريعة بالسنة السابقة (نفس الفترة)</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 rounded-r-lg cursor-pointer hover:bg-gray-100">المؤشر</th>
                                        <th scope="col" class="px-6 py-3 cursor-pointer hover:bg-gray-100">السنة الحالية (2025)</th>
                                        <th scope="col" class="px-6 py-3 cursor-pointer hover:bg-gray-100">السنة السابقة (2024)</th>
                                        <th scope="col" class="px-6 py-3 rounded-l-lg cursor-pointer hover:bg-gray-100">التغيير</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="bg-white border-b hover:bg-gray-50">
                                        <td class="px-6 py-4 font-medium text-gray-900">إجمالي المحصل</td>
                                        <td class="px-6 py-4 font-bold">480,500 ر.س</td>
                                        <td class="px-6 py-4">410,000 ر.س</td>
                                        <td class="px-6 py-4 text-green-600 font-bold">+17%</td>
                                    </tr>
                                    <tr class="bg-white hover:bg-gray-50">
                                        <td class="px-6 py-4 font-medium text-gray-900">نسبة التحصيل</td>
                                        <td class="px-6 py-4 font-bold">89%</td>
                                        <td class="px-6 py-4">85%</td>
                                        <td class="px-6 py-4 text-green-600 font-bold">+4%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page 2: Account Analysis -->
                <div id="accounts" class="page">
                    <div class="bg-white p-4 rounded-xl shadow-sm mb-6 flex flex-col md:flex-row gap-4 items-center justify-between">
                        <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                            <div class="relative w-full md:w-auto">
                                <select class="w-full md:w-48 bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block px-4 py-2.5 outline-none">
                                    <option>2025</option>
                                    <option>2024</option>
                                </select>
                            </div>
                            <div class="relative w-full md:w-auto">
                                <select class="w-full md:w-48 bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block px-4 py-2.5 outline-none">
                                    <option>جميع التبويبات</option>
                                    <option>منتج</option>
                                    <option>خدمة</option>
                                </select>
                            </div>
                        </div>
                        <button class="w-full md:w-auto bg-blue-900 hover:bg-blue-800 text-white font-medium rounded-lg text-sm px-5 py-2.5 transition">تطبيق</button>
                    </div>

                    <!-- Charts Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-6">
                        <div class="card p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-gray-800 text-sm">أعلى حسابات الإيراد</h3>
                                <button class="text-gray-400 hover:text-blue-900"><i class="ph ph-dots-three-outline text-lg"></i></button>
                            </div>
                            <div class="relative h-64 w-full flex items-center justify-center">
                                <canvas id="accountsChart"></canvas>
                            </div>
                        </div>

                        <div class="card p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-gray-800 text-sm">نسبة تحقيق المستهدف</h3>
                                <button class="text-gray-400 hover:text-blue-900"><i class="ph ph-dots-three-outline text-lg"></i></button>
                            </div>
                            <div class="relative h-64 w-full flex items-center justify-center">
                                <canvas id="accountsTargetChart"></canvas>
                            </div>
                        </div>

                        <div class="card p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-gray-800 text-sm">مقارنة المفوتر والمحصل</h3>
                                <button class="text-gray-400 hover:text-blue-900"><i class="ph ph-dots-three-outline text-lg"></i></button>
                            </div>
                            <div class="relative h-64 w-full flex items-center justify-center">
                                <canvas id="accountsBarChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="card p-4 mb-6">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-800 text-sm">جدول ملخص حسابات الإيراد</h3>
                            <input type="text" id="accountsSearch" placeholder="بحث عن حساب..." class="bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block px-4 py-2.5 outline-none w-64">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">حساب الإيراد</th>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">المفوتر</th>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">المحصل</th>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">نسبة التحصيل</th>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">المستهدف</th>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">تحقيق المستهدف</th>
                                    </tr>
                                </thead>
                                <tbody id="accountsTableBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page 3: Tab Analysis -->
                <div id="tabs" class="page">
                    <div class="bg-white p-4 rounded-xl shadow-sm mb-6 flex flex-col md:flex-row gap-4 items-center justify-between">
                        <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                            <div class="relative w-full md:w-auto">
                                <select class="w-full md:w-48 bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block px-4 py-2.5 outline-none">
                                    <option>2025</option>
                                </select>
                            </div>
                            <div class="relative w-full md:w-auto">
                                <select class="w-full md:w-48 bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block px-4 py-2.5 outline-none">
                                    <option>جميع الحسابات</option>
                                    <option>استشارات</option>
                                    <option>مبيعات</option>
                                    <option>خدمات</option>
                                </select>
                            </div>
                        </div>
                        <button class="w-full md:w-auto bg-blue-900 hover:bg-blue-800 text-white font-medium rounded-lg text-sm px-5 py-2.5 transition">تطبيق</button>
                    </div>

                    <!-- Charts Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-6">
                        <div class="card p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-gray-800 text-sm">توزيع الإيراد حسب التبويب</h3>
                                <button class="text-gray-400 hover:text-blue-900"><i class="ph ph-dots-three-outline text-lg"></i></button>
                            </div>
                            <div class="relative h-64 w-full flex items-center justify-center">
                                <canvas id="tabsChart"></canvas>
                            </div>
                        </div>

                        <div class="card p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-gray-800 text-sm">أعلى التبويبات</h3>
                                <button class="text-gray-400 hover:text-blue-900"><i class="ph ph-dots-three-outline text-lg"></i></button>
                            </div>
                            <div class="relative h-64 w-full flex items-center justify-center">
                                <canvas id="tabsBarChart"></canvas>
                            </div>
                        </div>

                        <div class="card p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-gray-800 text-sm">الإيراد الشهري حسب التبويب</h3>
                                <button class="text-gray-400 hover:text-blue-900"><i class="ph ph-dots-three-outline text-lg"></i></button>
                            </div>
                            <div class="relative h-64 w-full flex items-center justify-center">
                                <canvas id="tabsMonthlyChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="card p-4 mb-6">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-800 text-sm">جدول حسب التبويب</h3>
                            <input type="text" id="tabsSearch" placeholder="بحث..." class="bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block px-4 py-2.5 outline-none w-48">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">التبويب</th>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">المحصل</th>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">المفوتر</th>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">نسبة التحصيل</th>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">نسبة المشاركة</th>
                                    </tr>
                                </thead>
                                <tbody id="tabsTableBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page 4: Year Comparison -->
                <div id="comparison" class="page">
                    <div class="bg-white p-4 rounded-xl shadow-sm mb-6 flex flex-col md:flex-row gap-4 items-center justify-between">
                        <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                            <div class="relative w-full md:w-auto">
                                <div class="bg-gray-50 border border-gray-200 rounded-lg px-4 py-2.5">
                                    <div class="flex flex-row gap-4 items-center flex-wrap">
                                        <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-100 -mx-2 px-2 py-1 rounded transition">
                                            <input type="checkbox" name="comparisonYears" value="2025" checked class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2">
                                            <span class="text-sm text-gray-700">2025</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-100 -mx-2 px-2 py-1 rounded transition">
                                            <input type="checkbox" name="comparisonYears" value="2024" checked class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2">
                                            <span class="text-sm text-gray-700">2024</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-100 -mx-2 px-2 py-1 rounded transition">
                                            <input type="checkbox" name="comparisonYears" value="2023" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2">
                                            <span class="text-sm text-gray-700">2023</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button onclick="updateComparison()" class="w-full md:w-auto bg-blue-900 hover:bg-blue-800 text-white font-medium rounded-lg text-sm px-5 py-2.5 transition">تطبيق</button>
                    </div>

                    <!-- Charts Grid -->
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-6">
                        <div class="card p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-gray-800 text-sm">مقارنة السنوات</h3>
                                <button class="text-gray-400 hover:text-blue-900"><i class="ph ph-dots-three-outline text-lg"></i></button>
                            </div>
                            <div class="relative h-80 w-full flex items-center justify-center">
                                <canvas id="comparisonChart"></canvas>
                            </div>
                        </div>

                        <div class="card p-4">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-gray-800 text-sm">مقارنة بالمستهدف الشهري</h3>
                                <button class="text-gray-400 hover:text-blue-900"><i class="ph ph-dots-three-outline text-lg"></i></button>
                            </div>
                            <div class="relative h-80 w-full flex items-center justify-center">
                                <canvas id="targetComparisonChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="card p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-800 text-sm">جدول سنوي مختصر</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">السنة</th>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">المفوتر</th>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">المحصل</th>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">المستهدف</th>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">تحقيق المستهدف</th>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">النمو</th>
                                    </tr>
                                </thead>
                                <tbody id="yearlyTableBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Page 5: Detail Table -->
                <div id="details" class="page">
                    <div class="bg-white p-4 rounded-xl shadow-sm mb-6 flex flex-col gap-4">
                        <div class="flex flex-col md:flex-row gap-3">
                            <div class="relative w-full md:w-auto">
                                <select class="w-full md:w-48 bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block px-4 py-2.5 outline-none">
                                    <option>2025</option>
                                    <option>2024</option>
                                    <option>2023</option>
                                </select>
                            </div>
                            <div class="relative w-full md:w-auto">
                                <select class="w-full md:w-48 bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block px-4 py-2.5 outline-none">
                                    <option>جميع الحسابات</option>
                                    <option>استشارات</option>
                                    <option>مبيعات</option>
                                    <option>خدمات</option>
                                </select>
                            </div>
                            <div class="relative w-full md:w-auto">
                                <select class="w-full md:w-48 bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block px-4 py-2.5 outline-none">
                                    <option>جميع التبويبات</option>
                                    <option>منتج</option>
                                    <option>خدمة</option>
                                    <option>استشارة</option>
                                </select>
                            </div>
                            <div class="relative w-full md:w-auto flex gap-2">
                                <input type="number" placeholder="من" class="w-full md:w-24 bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block px-4 py-2.5 outline-none">
                                <input type="number" placeholder="إلى" class="w-full md:w-24 bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block px-4 py-2.5 outline-none">
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button class="bg-blue-900 hover:bg-blue-800 text-white font-medium rounded-lg text-sm px-5 py-2.5 transition">تطبيق</button>
                            <button id="exportExcelBtn" class="bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg text-sm px-5 py-2.5 transition flex items-center gap-2">
                                <i class="ph ph-download"></i>
                                تصدير Excel
                            </button>
                        </div>
                    </div>

                    <div class="card p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-800 text-sm">جدول البيانات التفصيلية</h3>
                            <input type="text" id="detailsSearch" placeholder="بحث..." class="bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block px-4 py-2.5 outline-none w-64">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right" id="detailsTable">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">تاريخ الحركة</th>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">السنة</th>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">الشهر</th>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">حساب الإيراد</th>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">التبويب</th>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">المفوتر</th>
                                        <th class="px-6 py-3 cursor-pointer hover:bg-gray-100 sortable">المحصل</th>
                                    </tr>
                                </thead>
                                <tbody id="detailsTableBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex justify-between items-center">
                            <div class="text-sm text-gray-500">عرض 1-10 من 150</div>
                            <div class="flex gap-2">
                                <button id="prevPageBtn" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50">السابق</button>
                                <button id="nextPageBtn" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50">التالي</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Mobile Menu -->
    <div id="mobileMenuOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>
    <aside id="mobileSidebar" class="fixed top-0 right-0 z-40 w-64 h-screen transition-transform translate-x-full bg-white border-l border-gray-200 lg:hidden">
        <div class="p-6 flex items-center justify-between border-b border-gray-100">
            <div class="text-xl font-bold text-blue-900 flex items-center gap-2">
                <i class="ph ph-chart-polar"></i>
                <span>إيراداتي</span>
            </div>
            <button id="closeMobileMenu" class="text-gray-500"><i class="ph ph-x text-xl"></i></button>
        </div>
        <nav class="p-4 space-y-2">
            <a href="#" onclick="showPage('overview'); toggleMobileMenu(); return false;" class="flex items-center gap-3 p-3 text-blue-900 bg-blue-50 rounded-lg font-bold">ملخص الإيرادات</a>
            <a href="#" onclick="showPage('accounts'); toggleMobileMenu(); return false;" class="flex items-center gap-3 p-3 text-gray-500">تحليل الحسابات</a>
            <a href="#" onclick="showPage('tabs'); toggleMobileMenu(); return false;" class="flex items-center gap-3 p-3 text-gray-500">تحليل التبويب</a>
            <a href="#" onclick="showPage('comparison'); toggleMobileMenu(); return false;" class="flex items-center gap-3 p-3 text-gray-500">مقارنة السنوات</a>
            <a href="#" onclick="showPage('details'); toggleMobileMenu(); return false;" class="flex items-center gap-3 p-3 text-gray-500">الجدول التفصيلي</a>
        </nav>
    </aside>

    <script>
        // ============================================
        // THEME MANAGEMENT
        // ============================================
        function toggleThemeDropdown() {
            const dropdown = document.getElementById('themeDropdownMenu');
            if (dropdown) {
                dropdown.classList.toggle('hidden');
            }
        }
        
        function selectTheme(themeName) {
            applyTheme(themeName);
            updateThemeDropdownUI(themeName);
            const dropdown = document.getElementById('themeDropdownMenu');
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
        }
        
        function updateThemeDropdownUI(themeName) {
            const themeLabels = {
                'light': 'فاتح',
                'dark': 'داكن',
                'mono': 'أحادي'
            };
            
            // Update button label
            const label = document.getElementById('themeCurrentLabel');
            if (label) {
                label.textContent = themeLabels[themeName] || 'فاتح';
            }
            
            // Update checkmarks
            document.querySelectorAll('.theme-option').forEach(option => {
                const check = option.querySelector('.theme-check');
                if (option.getAttribute('data-theme') === themeName) {
                    if (check) check.classList.remove('hidden');
                } else {
                    if (check) check.classList.add('hidden');
                }
            });
        }
        
        function applyTheme(themeName) {
            document.body.setAttribute('data-theme', themeName);
            saveTheme(themeName);
            
            // Re-render charts with new theme colors
            const currentPage = document.querySelector('.page.active')?.id;
            if (currentPage) {
                const filters = getCurrentFilters();
                fetchRevenueDataCached(filters).then(data => {
                    if (data) {
                        if (currentPage === 'overview') {
                            initOverviewCharts(data);
                            updateKPIs(data);
                        } else if (currentPage === 'accounts') {
                            initAccountsPage(data);
                        } else if (currentPage === 'tabs') {
                            initTabsPage(data);
                        } else if (currentPage === 'comparison') {
                            initComparisonPage(data);
                        } else if (currentPage === 'details') {
                            initDetailsPage(data);
                        }
                    }
                });
            }
        }
        
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('dashboardTheme');
            if (savedTheme && ['light', 'dark', 'mono'].includes(savedTheme)) {
                applyTheme(savedTheme);
                // Update dropdown UI after a short delay to ensure DOM is ready
                setTimeout(() => updateThemeDropdownUI(savedTheme), 100);
            } else {
                applyTheme('light');
                setTimeout(() => updateThemeDropdownUI('light'), 100);
            }
        }
        
        function saveTheme(themeName) {
            localStorage.setItem('dashboardTheme', themeName);
        }
        
        function getChartColors() {
            const theme = document.body.getAttribute('data-theme') || 'light';
            
            const lightColors = {
                primary: '#3B82F6',
                secondary: '#10B981',
                accent: '#F59E0B',
                purple: '#8B5CF6',
                red: '#EF4444',
                blue: '#2563EB',
                green: '#059669',
                orange: '#D97706'
            };
            
            const darkColors = {
                primary: '#3B82F6',
                secondary: '#10B981',
                accent: '#F59E0B',
                purple: '#A855F7',
                red: '#EF4444',
                blue: '#3B9AF6',
                green: '#10F981',
                orange: '#F59E0B'
            };
            
            const monoColors = {
                primary: '#14b8a6',
                secondary: '#0f766e',
                accent: '#5eead4',
                purple: '#0d9488',
                red: '#134e4a',
                blue: '#14b8a6',
                green: '#0f766e',
                orange: '#5eead4'
            };
            
            switch(theme) {
                case 'dark':
                    return darkColors;
                case 'mono':
                    return monoColors;
                default:
                    return lightColors;
            }
        }
        
        // ============================================
        // DATA SERVICE - Read from Excel File
        // ============================================
        const DataService = {
            // Excel file path
            EXCEL_FILE_PATH: 'dashboard-data.xlsx',
            
            // Cache for parsed data
            cachedData: null,
            
            async fetchRevenueData(filters = {}) {
                try {
                    // Load and parse Excel file
                    const data = await this.loadExcelData();
                    if (!data) {
                        showErrorMessage('لم يتم العثور على ملف البيانات');
                        return null;
                    }
                    
                    // Apply filters to the data
                    return this.applyFilters(data, filters);
                } catch (error) {
                    console.error('Error fetching data:', error);
                    showErrorMessage('حدث خطأ في تحميل البيانات: ' + error.message);
                    return null;
                }
            },
            
            async loadExcelData() {
                // Return cached data if available
                if (this.cachedData) {
                    return this.cachedData;
                }
                
                try {
                    // Fetch the Excel file
                    const response = await fetch(this.EXCEL_FILE_PATH);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const arrayBuffer = await response.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    
                    // Get the first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON
                    const rawData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (rawData.length === 0) {
                        throw new Error('الملف فارغ');
                    }
                    
                    console.log('Excel file loaded successfully:', {
                        sheetName: firstSheetName,
                        rowCount: rawData.length,
                        sampleRow: rawData[0],
                        columns: Object.keys(rawData[0] || {})
                    });
                    
                    // Transform Excel data to dashboard format
                    this.cachedData = this.transformExcelData(rawData);
                    
                    console.log('Data transformed successfully:', {
                        monthlyRecords: this.cachedData.monthly.labels.length,
                        accountsCount: this.cachedData.accounts.length,
                        tabsCount: this.cachedData.tabs.length,
                        yearlyCount: this.cachedData.yearly.length,
                        detailsCount: this.cachedData.details.length
                    });
                    
                    return this.cachedData;
                } catch (error) {
                    console.error('Error loading Excel file:', error);
                    // Fallback to dummy data if Excel file can't be loaded
                    console.warn('Falling back to dummy data');
                    return this.getDummyData();
                }
            },
            
            transformExcelData(rawData) {
                // Arabic month names mapping
                const monthNames = {
                    'يناير': 'يناير', '1': 'يناير', '01': 'يناير',
                    'فبراير': 'فبراير', '2': 'فبراير', '02': 'فبراير',
                    'مارس': 'مارس', '3': 'مارس', '03': 'مارس',
                    'أبريل': 'أبريل', '4': 'أبريل', '04': 'أبريل',
                    'مايو': 'مايو', '5': 'مايو', '05': 'مايو',
                    'يونيو': 'يونيو', '6': 'يونيو', '06': 'يونيو',
                    'يوليو': 'يوليو', '7': 'يوليو', '07': 'يوليو',
                    'أغسطس': 'أغسطس', '8': 'أغسطس', '08': 'أغسطس',
                    'سبتمبر': 'سبتمبر', '9': 'سبتمبر', '09': 'سبتمبر',
                    'أكتوبر': 'أكتوبر', '10': 'أكتوبر',
                    'نوفمبر': 'نوفمبر', '11': 'نوفمبر',
                    'ديسمبر': 'ديسمبر', '12': 'ديسمبر'
                };
                
                const monthlyData = {};
                const accountsMap = {};
                const tabsMap = {};
                const yearlyMap = {};
                const details = [];
                
                rawData.forEach(row => {
                    // Extract data using exact column names from Excel
                    const transactionDate = row['تاريخ_الحركة'];
                    const year = parseInt(row['السنة']) || (transactionDate ? new Date(transactionDate).getFullYear() : new Date().getFullYear());
                    const monthInput = row['الشهر'];
                    const account = row['حساب_الإيراد'] || 'غير محدد';
                    const tab = row['التبويب'] || 'غير محدد';
                    const invoiced = parseFloat(row['الإيراد_المفوتر']) || 0;
                    const collected = parseFloat(row['الإيراد_المحصل']) || 0;
                    
                    // Parse date if available
                    let dateObj;
                    if (transactionDate) {
                        if (transactionDate instanceof Date) {
                            dateObj = transactionDate;
                        } else if (typeof transactionDate === 'string' || typeof transactionDate === 'number') {
                            dateObj = new Date(transactionDate);
                        } else {
                            dateObj = new Date();
                        }
                    } else {
                        // Try to construct date from year and month
                        const monthNum = this.getMonthNumber(monthInput);
                        dateObj = new Date(year, monthNum - 1, 1);
                    }
                    
                    // Get month name
                    let monthName = monthInput;
                    if (monthNames[monthInput]) {
                        monthName = monthNames[monthInput];
                    } else {
                        const monthNum = dateObj.getMonth() + 1;
                        const monthNamesArray = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 
                                                'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
                        monthName = monthNamesArray[monthNum - 1] || monthInput;
                    }
                    
                    const month = dateObj.getMonth() + 1; // 1-12
                    
                    // Monthly aggregation
                    const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = { 
                            invoiced: 0, 
                            collected: 0, 
                            month: monthName,
                            year: year,
                            monthNum: month
                        };
                    }
                    monthlyData[monthKey].invoiced += invoiced;
                    monthlyData[monthKey].collected += collected;
                    
                    // Accounts aggregation
                    if (!accountsMap[account]) {
                        accountsMap[account] = { 
                            name: account, 
                            invoiced: 0, 
                            collected: 0, 
                            target: 0 
                        };
                    }
                    accountsMap[account].invoiced += invoiced;
                    accountsMap[account].collected += collected;
                    
                    // Tabs aggregation
                    if (!tabsMap[tab]) {
                        tabsMap[tab] = { 
                            name: tab, 
                            invoiced: 0, 
                            collected: 0 
                        };
                    }
                    tabsMap[tab].invoiced += invoiced;
                    tabsMap[tab].collected += collected;
                    
                    // Yearly aggregation
                    if (!yearlyMap[year]) {
                        yearlyMap[year] = { 
                            year: year, 
                            invoiced: 0, 
                            collected: 0, 
                            target: 0 
                        };
                    }
                    yearlyMap[year].invoiced += invoiced;
                    yearlyMap[year].collected += collected;
                    
                    // Details
                    details.push({
                        date: dateObj.toISOString().split('T')[0],
                        year: year,
                        month: monthName,
                        account: account,
                        tab: tab,
                        invoiced: invoiced,
                        collected: collected
                    });
                });
                
                // Convert monthly data to arrays (sorted by year and month)
                const sortedMonths = Object.keys(monthlyData).sort();
                const monthly = {
                    labels: sortedMonths.map(key => monthlyData[key].month),
                    invoiced: sortedMonths.map(key => monthlyData[key].invoiced),
                    collected: sortedMonths.map(key => monthlyData[key].collected)
                };
                
                // Convert accounts to array
                const accounts = Object.values(accountsMap);
                
                // Calculate targets (20% above invoiced as default, adjust as needed)
                accounts.forEach(acc => {
                    acc.target = acc.invoiced > 0 ? Math.round(acc.invoiced * 1.2) : 0;
                });
                
                // Convert tabs to array and calculate percentages
                const totalCollected = accounts.reduce((sum, acc) => sum + acc.collected, 0);
                const tabs = Object.values(tabsMap).map(tab => ({
                    ...tab,
                    percentage: totalCollected > 0 ? Math.round((tab.collected / totalCollected) * 100) : 0
                }));
                
                // Convert yearly to array and calculate metrics
                const yearly = Object.values(yearlyMap).map(y => {
                    const prevYear = yearlyMap[y.year - 1];
                    const growth = prevYear && prevYear.collected > 0 
                        ? Math.round(((y.collected - prevYear.collected) / prevYear.collected) * 100) 
                        : 0;
                    // Calculate target (can be adjusted based on your business logic)
                    y.target = y.invoiced > 0 ? Math.round(y.invoiced * 2.2) : 0; // Example: 2.2x invoiced
                    const achievement = y.target > 0 ? Math.round((y.collected / y.target) * 100) : 0;
                    return { ...y, achievement, growth };
                }).sort((a, b) => b.year - a.year);
                
                return {
                    monthly,
                    accounts,
                    tabs,
                    yearly,
                    details: details.sort((a, b) => {
                        // Sort by date descending
                        return new Date(b.date) - new Date(a.date);
                    })
                };
            },
            
            getMonthNumber(monthInput) {
                if (!monthInput) return 1;
                
                const monthStr = String(monthInput).trim();
                const monthNames = {
                    'يناير': 1, 'فبراير': 2, 'مارس': 3, 'أبريل': 4,
                    'مايو': 5, 'يونيو': 6, 'يوليو': 7, 'أغسطس': 8,
                    'سبتمبر': 9, 'أكتوبر': 10, 'نوفمبر': 11, 'ديسمبر': 12
                };
                
                if (monthNames[monthStr]) {
                    return monthNames[monthStr];
                }
                
                const num = parseInt(monthStr);
                if (!isNaN(num) && num >= 1 && num <= 12) {
                    return num;
                }
                
                return 1; // Default to January
            },
            
            applyFilters(data, filters) {
                try {
                    if (!data || !data.details) {
                        console.warn('applyFilters: No data or details provided');
                        return data || this.getDummyData();
                    }
                    
                    let filteredData = JSON.parse(JSON.stringify(data)); // Deep copy
                    
                    // Apply year filter
                    if (filters.year) {
                        const year = parseInt(filters.year);
                        if (!isNaN(year)) {
                            filteredData.details = filteredData.details.filter(d => d && d.year === year);
                            
                            // Recalculate monthly data for filtered year
                            const monthlyData = {};
                            filteredData.details.forEach(d => {
                                if (d && d.month) {
                                    const monthNum = this.getMonthNumber(d.month);
                                    const monthKey = `${d.year}-${String(monthNum).padStart(2, '0')}`;
                                    if (!monthlyData[monthKey]) {
                                        monthlyData[monthKey] = { invoiced: 0, collected: 0, month: d.month };
                                    }
                                    monthlyData[monthKey].invoiced += (d.invoiced || 0);
                                    monthlyData[monthKey].collected += (d.collected || 0);
                                }
                            });
                            
                            const sortedMonths = Object.keys(monthlyData).sort();
                            filteredData.monthly = {
                                labels: sortedMonths.map(key => monthlyData[key].month),
                                invoiced: sortedMonths.map(key => monthlyData[key].invoiced),
                                collected: sortedMonths.map(key => monthlyData[key].collected)
                            };
                            
                            // Filter yearly data
                            if (filteredData.yearly) {
                                filteredData.yearly = filteredData.yearly.filter(y => y && y.year === year);
                            }
                        }
                    }
                    
                    // Apply account filter
                    if (filters.account && filters.account !== 'all' && filters.account !== null) {
                        filteredData.details = filteredData.details.filter(d => d && d.account === filters.account);
                        
                        // Recalculate accounts
                        const accountsMap = {};
                        filteredData.details.forEach(d => {
                            if (d && d.account) {
                                if (!accountsMap[d.account]) {
                                    accountsMap[d.account] = { name: d.account, invoiced: 0, collected: 0, target: 0 };
                                }
                                accountsMap[d.account].invoiced += (d.invoiced || 0);
                                accountsMap[d.account].collected += (d.collected || 0);
                            }
                        });
                        
                        filteredData.accounts = Object.values(accountsMap);
                        filteredData.accounts.forEach(acc => {
                            acc.target = acc.invoiced > 0 ? Math.round(acc.invoiced * 1.2) : 0;
                        });
                    }
                    
                    // Apply month range filter
                    if (filters.monthRange && filters.monthRange !== 'all') {
                        const parts = filters.monthRange.split('-');
                        if (parts.length === 2) {
                            const startMonth = parseInt(parts[0]);
                            const endMonth = parseInt(parts[1]);
                            
                            if (!isNaN(startMonth) && !isNaN(endMonth)) {
                                filteredData.details = filteredData.details.filter(d => {
                                    if (!d || !d.month) return false;
                                    const monthNum = this.getMonthNumber(d.month);
                                    return monthNum >= startMonth && monthNum <= endMonth;
                                });
                                
                                // Recalculate monthly data
                                const monthlyData = {};
                                filteredData.details.forEach(d => {
                                    if (d && d.month) {
                                        const monthNum = this.getMonthNumber(d.month);
                                        const monthKey = `${d.year}-${String(monthNum).padStart(2, '0')}`;
                                        if (!monthlyData[monthKey]) {
                                            monthlyData[monthKey] = { invoiced: 0, collected: 0, month: d.month };
                                        }
                                        monthlyData[monthKey].invoiced += (d.invoiced || 0);
                                        monthlyData[monthKey].collected += (d.collected || 0);
                                    }
                                });
                                
                                const sortedMonths = Object.keys(monthlyData).sort();
                                filteredData.monthly = {
                                    labels: sortedMonths.map(key => monthlyData[key].month),
                                    invoiced: sortedMonths.map(key => monthlyData[key].invoiced),
                                    collected: sortedMonths.map(key => monthlyData[key].collected)
                                };
                            }
                        }
                    }
                    
                    // Ensure all required properties exist
                    if (!filteredData.monthly) filteredData.monthly = { labels: [], invoiced: [], collected: [] };
                    if (!filteredData.accounts) filteredData.accounts = [];
                    if (!filteredData.tabs) filteredData.tabs = [];
                    if (!filteredData.yearly) filteredData.yearly = [];
                    if (!filteredData.details) filteredData.details = [];
                    
                    return filteredData;
                } catch (error) {
                    console.error('Error in applyFilters:', error);
                    // Return original data if filtering fails
                    return data || this.getDummyData();
                }
            },
            
            // Keep dummy data as fallback
            getDummyData(filters) {
                const currentYear = new Date().getFullYear();
                const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
                const accounts = ['استشارات', 'مبيعات', 'خدمات'];
                const tabs = ['منتج', 'خدمة', 'استشارة', 'أخرى'];
                
                // Generate sample details
                const details = [];
                for (let i = 0; i < 30; i++) {
                    const monthIndex = i % 12;
                    const account = accounts[i % accounts.length];
                    const tab = tabs[i % tabs.length];
                    const date = new Date(currentYear, monthIndex, (i % 28) + 1);
                    const invoiced = Math.floor(Math.random() * 50000) + 10000;
                    const collected = Math.floor(invoiced * 0.9);
                    
                    details.push({
                        date: date.toISOString().split('T')[0],
                        year: currentYear,
                        month: months[monthIndex],
                        account: account,
                        tab: tab,
                        invoiced: invoiced,
                        collected: collected
                    });
                }
                
                return {
                    monthly: {
                        labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'],
                        invoiced: [70000, 62000, 85000, 90000, 60000, 100000],
                        collected: [65000, 59000, 80000, 81000, 56000, 95000]
                    },
                    accounts: [
                        { name: 'استشارات', invoiced: 250000, collected: 230000, target: 300000 },
                        { name: 'مبيعات', invoiced: 180000, collected: 165000, target: 200000 },
                        { name: 'خدمات', invoiced: 110200, collected: 85500, target: 150000 }
                    ],
                    tabs: [
                        { name: 'منتج', collected: 200000, invoiced: 220000, percentage: 42 },
                        { name: 'خدمة', collected: 150000, invoiced: 160000, percentage: 31 },
                        { name: 'استشارة', collected: 100000, invoiced: 110000, percentage: 21 },
                        { name: 'أخرى', collected: 30500, invoiced: 50200, percentage: 6 }
                    ],
                    yearly: [
                        { year: 2025, invoiced: 540200, collected: 480500, target: 1200000, achievement: 40, growth: 15 },
                        { year: 2024, invoiced: 480000, collected: 410000, target: 1100000, achievement: 37, growth: 12 },
                        { year: 2023, invoiced: 420000, collected: 365000, target: 1000000, achievement: 37, growth: 8 }
                    ],
                    details: details.sort((a, b) => new Date(b.date) - new Date(a.date))
                };
            },
            
            // Method to clear cache (useful for refresh)
            clearCache() {
                this.cachedData = null;
            }
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showErrorMessage(message) {
            const toast = document.createElement('div');
            toast.className = 'toast bg-red-500 text-white';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.className = 'toast bg-green-500 text-white';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showLoadingState() {
            document.querySelectorAll('.card canvas').forEach(canvas => {
                if (!canvas.parentElement.querySelector('.loading-spinner')) {
                    const spinner = document.createElement('div');
                    spinner.className = 'loading-spinner';
                    spinner.innerHTML = '<i class="ph ph-spinner text-2xl text-blue-600"></i>';
                    canvas.parentElement.appendChild(spinner);
                }
            });
        }

        function hideLoadingState() {
            document.querySelectorAll('.loading-spinner').forEach(spinner => spinner.remove());
        }

        // ============================================
        // FILTER FUNCTIONALITY
        // ============================================
        async function applyFilters() {
            if (!validateFilters()) return;
            
            showLoadingState();
            
            const filters = {
                year: document.getElementById('filterYear').value,
                monthRange: document.getElementById('filterMonthRange').value,
                account: document.getElementById('filterAccount').value === 'all' ? null : document.getElementById('filterAccount').value
            };
            
            try {
                console.log('Applying filters:', filters);
                const data = await DataService.fetchRevenueData(filters);
                if (data) {
                    console.log('Filters applied successfully, data received:', {
                        detailsCount: data.details?.length || 0,
                        accountsCount: data.accounts?.length || 0
                    });
                    updateKPIs(data);
                    updateCharts(data);
                    updateTables(data); // Make sure tables are updated too
                    saveUserPreferences();
                } else {
                    console.warn('applyFilters: No data returned from fetchRevenueData');
                    showErrorMessage('لم يتم العثور على بيانات');
                }
            } catch (error) {
                console.error('Error in applyFilters:', error);
                showErrorMessage('حدث خطأ في تطبيق الفلاتر: ' + (error.message || 'خطأ غير معروف'));
            } finally {
                hideLoadingState();
            }
        }

        function validateFilters() {
            const year = document.getElementById('filterYear').value;
            if (!year || year < 2020 || year > 2030) {
                showErrorMessage('يرجى اختيار سنة صحيحة');
                return false;
            }
            return true;
        }

        function getCurrentFilters() {
            return {
                year: document.getElementById('filterYear').value,
                monthRange: document.getElementById('filterMonthRange').value,
                account: document.getElementById('filterAccount').value
            };
        }

        // ============================================
        // SEARCH FUNCTIONALITY
        // ============================================
        function setupSearch() {
            // Global search
            const globalSearch = document.getElementById('globalSearch');
            if (globalSearch) {
                globalSearch.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    document.querySelectorAll('table tbody tr').forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(term) ? '' : 'none';
                    });
                });
            }

            // Table-specific searches
            ['accountsSearch', 'tabsSearch', 'detailsSearch'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', (e) => {
                        const term = e.target.value.toLowerCase();
                        const table = e.target.closest('.card').querySelector('table tbody');
                        if (table) {
                            table.querySelectorAll('tr').forEach(row => {
                                const text = row.textContent.toLowerCase();
                                row.style.display = text.includes(term) ? '' : 'none';
                            });
                        }
                    });
                }
            });
        }

        // ============================================
        // TABLE SORTING
        // ============================================
        function setupTableSorting() {
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const table = header.closest('table');
                    const columnIndex = Array.from(header.parentElement.children).indexOf(header);
                    const isAsc = header.classList.contains('sort-asc');
                    
                    // Remove all sort classes
                    header.parentElement.querySelectorAll('.sort-asc, .sort-desc').forEach(h => {
                        h.classList.remove('sort-asc', 'sort-desc');
                    });
                    
                    // Add sort class
                    header.classList.add(isAsc ? 'sort-desc' : 'sort-asc');
                    
                    sortTable(table, columnIndex, !isAsc);
                });
            });
        }

        function sortTable(table, columnIndex, ascending = true) {
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            rows.sort((a, b) => {
                const aText = a.children[columnIndex].textContent.trim();
                const bText = b.children[columnIndex].textContent.trim();
                
                // Try to parse as numbers
                const aNum = parseFloat(aText.replace(/[^\d.-]/g, ''));
                const bNum = parseFloat(bText.replace(/[^\d.-]/g, ''));
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return ascending ? aNum - bNum : bNum - aNum;
                }
                
                return ascending 
                    ? aText.localeCompare(bText, 'ar')
                    : bText.localeCompare(aText, 'ar');
            });
            
            rows.forEach(row => tbody.appendChild(row));
        }

        // ============================================
        // EXPORT FUNCTIONALITY
        // ============================================
        function setupExport() {
            const exportBtn = document.getElementById('exportExcelBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    const table = document.getElementById('detailsTable');
                    if (table) {
                        const wb = XLSX.utils.table_to_book(table);
                        XLSX.writeFile(wb, `revenue-details-${new Date().toISOString().split('T')[0]}.xlsx`);
                        showSuccessMessage('تم تصدير البيانات بنجاح');
                    }
                });
            }
        }

        // ============================================
        // USER PREFERENCES (LocalStorage)
        // ============================================
        function saveUserPreferences() {
            const preferences = {
                defaultYear: document.getElementById('filterYear').value,
                defaultAccount: document.getElementById('filterAccount').value,
                lastUpdate: Date.now()
            };
            localStorage.setItem('dashboardPreferences', JSON.stringify(preferences));
        }

        function loadUserPreferences() {
            const saved = localStorage.getItem('dashboardPreferences');
            if (saved) {
                try {
                    const preferences = JSON.parse(saved);
                    if (preferences.defaultYear) {
                        document.getElementById('filterYear').value = preferences.defaultYear;
                    }
                    if (preferences.defaultAccount) {
                        document.getElementById('filterAccount').value = preferences.defaultAccount;
                    }
                } catch (e) {
                    console.error('Error loading preferences:', e);
                }
            }
        }

        // ============================================
        // DATA CACHING
        // ============================================
        const dataCache = new Map();
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

        async function fetchRevenueDataCached(filters) {
            const cacheKey = JSON.stringify(filters);
            
            if (dataCache.has(cacheKey)) {
                const cached = dataCache.get(cacheKey);
                if (Date.now() - cached.timestamp < CACHE_DURATION) {
                    return cached.data;
                }
            }
            
            const data = await DataService.fetchRevenueData(filters);
            if (data) {
                dataCache.set(cacheKey, {
                    data: data,
                    timestamp: Date.now()
                });
            }
            
            return data;
        }

        // ============================================
        // UPDATE FUNCTIONS
        // ============================================
        function updateKPIs(data) {
            if (!data) return;
            
            const totalInvoiced = data.accounts.reduce((sum, acc) => sum + acc.invoiced, 0);
            const totalCollected = data.accounts.reduce((sum, acc) => sum + acc.collected, 0);
            const gap = totalInvoiced - totalCollected;
            const collectionRate = Math.round((totalCollected / totalInvoiced) * 100);
            
            document.getElementById('kpi-invoiced').textContent = totalInvoiced.toLocaleString();
            document.getElementById('kpi-collected').textContent = totalCollected.toLocaleString();
            document.getElementById('kpi-gap').textContent = gap.toLocaleString();
            document.getElementById('kpi-collection-rate').textContent = collectionRate;
            
            // Update progress bar
            const progressBar = document.getElementById('collection-rate-progress');
            if (progressBar) {
                progressBar.style.width = collectionRate + '%';
            }
        }

        function updateCharts(data) {
            if (!data) return;
            
            // Reinitialize charts with new data
            if (document.getElementById('overview').classList.contains('active')) {
                initOverviewCharts(data);
            } else if (document.getElementById('accounts').classList.contains('active')) {
                initAccountsPage(data);
            } else if (document.getElementById('tabs').classList.contains('active')) {
                initTabsPage(data);
            } else if (document.getElementById('comparison').classList.contains('active')) {
                initComparisonPage(data);
            }
        }

        function updateTables(data) {
            if (!data) return;
            
            if (document.getElementById('accounts').classList.contains('active')) {
                initAccountsPage(data);
            } else if (document.getElementById('tabs').classList.contains('active')) {
                initTabsPage(data);
            } else if (document.getElementById('details').classList.contains('active')) {
                initDetailsPage(data);
            }
        }

        // ============================================
        // REFRESH FUNCTIONALITY
        // ============================================
        function setupRefresh() {
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', async () => {
                    refreshBtn.classList.add('animate-spin');
                    // Clear Excel cache and data cache
                    DataService.clearCache();
                    dataCache.clear();
                    await applyFilters();
                    refreshBtn.classList.remove('animate-spin');
                    showSuccessMessage('تم تحديث البيانات');
                });
            }
        }

        // ============================================
        // PAGE NAVIGATION
        // ============================================
        const pageTitles = {
            'overview': 'ملخص الإيرادات',
            'accounts': 'تحليل حسب حساب الإيراد',
            'tabs': 'تحليل حسب التبويب',
            'comparison': 'مقارنة السنوات والمستهدف',
            'details': 'الجدول التفصيلي'
        };

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.getElementById('pageTitle').textContent = pageTitles[pageId];
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active', 'bg-blue-900', 'text-white');
                item.classList.add('text-gray-500');
            });
            
            const clickedItem = event.target.closest('.nav-item');
            if (clickedItem) {
                clickedItem.classList.add('active', 'bg-blue-900', 'text-white');
                clickedItem.classList.remove('text-gray-500');
            }
            
            // Load data for the page
            loadPageData(pageId);
        }

        async function loadPageData(pageId) {
            const filters = getCurrentFilters();
            const data = await fetchRevenueDataCached(filters);
            
            if (data) {
                if (pageId === 'overview') {
                    initOverviewCharts(data);
                } else if (pageId === 'accounts') {
                    initAccountsPage(data);
                } else if (pageId === 'tabs') {
                    initTabsPage(data);
                } else if (pageId === 'comparison') {
                    initComparisonPage(data);
                } else if (pageId === 'details') {
                    initDetailsPage(data);
                }
            }
        }

        // ============================================
        // MOBILE MENU
        // ============================================
        function toggleMobileMenu() {
            const sidebar = document.getElementById('mobileSidebar');
            const overlay = document.getElementById('mobileMenuOverlay');
            const isClosed = sidebar.classList.contains('translate-x-full');
            if (isClosed) {
                sidebar.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
        document.getElementById('closeMobileMenu').addEventListener('click', toggleMobileMenu);
        document.getElementById('mobileMenuOverlay').addEventListener('click', toggleMobileMenu);

        // ============================================
        // CHARTS INITIALIZATION
        // ============================================
        let mainChart, targetChart, accountsChart, tabsChart, comparisonChart, targetComparisonChart;
        let accountsComparisonChart, accountsDistributionChart, collectionRateChart, stackedMonthlyChart;
        let accountsTargetChart, accountsBarChart, tabsBarChart, tabsMonthlyChart;

        function initOverviewCharts(data) {
            if (!data) data = DataService.getDummyData();
            const colors = getChartColors();
            
            // Main Chart
            const ctxMain = document.getElementById('mainChart');
            if (mainChart) mainChart.destroy();
            mainChart = new Chart(ctxMain, {
                type: 'line',
                data: {
                    labels: data.monthly.labels,
                    datasets: [
                        {
                            label: 'المحصل',
                            data: data.monthly.collected,
                            borderColor: colors.secondary,
                            backgroundColor: colors.secondary + '1A',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'المفوتر',
                            data: data.monthly.invoiced,
                            borderColor: colors.primary,
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            align: 'end',
                            labels: { font: { family: 'Cairo' }, usePointStyle: true }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toLocaleString()} ر.س`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [2, 4] } },
                        x: { grid: { display: false } }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const month = data.monthly.labels[elements[0].index];
                            showSuccessMessage(`تم اختيار شهر: ${month}`);
                        }
                    }
                }
            });

            // Target Chart
            const ctxTarget = document.getElementById('targetChart');
            if (targetChart) targetChart.destroy();
            const bgSecondary = document.body.getAttribute('data-theme') === 'dark' ? '#334155' : 
                               document.body.getAttribute('data-theme') === 'mono' ? '#f0fdfa' : '#F3F4F6';
            targetChart = new Chart(ctxTarget, {
                type: 'doughnut',
                data: {
                    labels: ['محقق', 'متبقي'],
                    datasets: [{
                        data: [40, 60],
                        backgroundColor: [colors.primary, bgSecondary],
                        borderWidth: 0,
                        cutout: '75%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });

            // Accounts Comparison Chart
            const ctxAccComp = document.getElementById('accountsComparisonChart');
            if (accountsComparisonChart) accountsComparisonChart.destroy();
            accountsComparisonChart = new Chart(ctxAccComp, {
                type: 'bar',
                data: {
                    labels: data.accounts.map(a => a.name),
                    datasets: [
                        {
                            label: 'المفوتر',
                            data: data.accounts.map(a => a.invoiced),
                            backgroundColor: colors.primary,
                            borderRadius: 6
                        },
                        {
                            label: 'المحصل',
                            data: data.accounts.map(a => a.collected),
                            backgroundColor: colors.secondary,
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', align: 'end' }
                    },
                    scales: {
                        y: { beginAtZero: true },
                        x: { grid: { display: false } }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const accountName = data.accounts[elements[0].index].name;
                            document.getElementById('filterAccount').value = accountName;
                            applyFilters();
                        }
                    }
                }
            });

            // Accounts Distribution Chart
            const ctxAccDist = document.getElementById('accountsDistributionChart');
            if (accountsDistributionChart) accountsDistributionChart.destroy();
            accountsDistributionChart = new Chart(ctxAccDist, {
                type: 'pie',
                data: {
                    labels: data.accounts.map(a => a.name),
                    datasets: [{
                        data: data.accounts.map(a => a.collected),
                        backgroundColor: [colors.primary, colors.secondary, colors.accent],
                        borderWidth: 2,
                        borderColor: document.body.getAttribute('data-theme') === 'dark' ? '#1E293B' : '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const accountName = data.accounts[elements[0].index].name;
                            document.getElementById('filterAccount').value = accountName;
                            applyFilters();
                        }
                    }
                }
            });

            // Collection Rate Chart
            const ctxCollRate = document.getElementById('collectionRateChart');
            if (collectionRateChart) collectionRateChart.destroy();
            const collectionRates = data.monthly.labels.map((_, i) => 
                Math.round((data.monthly.collected[i] / data.monthly.invoiced[i]) * 100)
            );
            collectionRateChart = new Chart(ctxCollRate, {
                type: 'line',
                data: {
                    labels: data.monthly.labels,
                    datasets: [{
                        label: 'نسبة التحصيل %',
                        data: collectionRates,
                        borderColor: colors.purple,
                        backgroundColor: colors.purple + '1A',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointBackgroundColor: colors.purple
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: false,
                            min: 80,
                            max: 100,
                            ticks: { suffix: '%' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Stacked Monthly Chart
            const ctxStacked = document.getElementById('stackedMonthlyChart');
            if (stackedMonthlyChart) stackedMonthlyChart.destroy();
            stackedMonthlyChart = new Chart(ctxStacked, {
                type: 'bar',
                data: {
                    labels: data.monthly.labels,
                    datasets: [
                        {
                            label: 'استشارات',
                            data: [20000, 18000, 25000, 28000, 20000, 30000],
                            backgroundColor: colors.primary
                        },
                        {
                            label: 'مبيعات',
                            data: [25000, 22000, 30000, 32000, 20000, 40000],
                            backgroundColor: colors.secondary
                        },
                        {
                            label: 'خدمات',
                            data: [20000, 19000, 25000, 21000, 16000, 25000],
                            backgroundColor: colors.accent
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', align: 'end' }
                    },
                    scales: {
                        x: { stacked: true, grid: { display: false } },
                        y: { stacked: true, beginAtZero: true }
                    }
                }
            });
        }

        function initAccountsPage(data) {
            if (!data) data = DataService.getDummyData();
            const colors = getChartColors();
            
            // Populate accounts table
            const tbody = document.getElementById('accountsTableBody');
            tbody.innerHTML = data.accounts.map(acc => {
                const rate = Math.round((acc.collected / acc.invoiced) * 100);
                const targetRate = Math.round((acc.collected / acc.target) * 100);
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium">${acc.name}</td>
                        <td class="px-6 py-4">${acc.invoiced.toLocaleString()} ر.س</td>
                        <td class="px-6 py-4 font-bold">${acc.collected.toLocaleString()} ر.س</td>
                        <td class="px-6 py-4">${rate}%</td>
                        <td class="px-6 py-4">${acc.target.toLocaleString()} ر.س</td>
                        <td class="px-6 py-4">${targetRate}%</td>
                    </tr>
                `;
            }).join('');

            // Accounts Chart
            const ctx = document.getElementById('accountsChart');
            if (accountsChart) accountsChart.destroy();
            accountsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.accounts.map(a => a.name),
                    datasets: [{
                        label: 'المحصل',
                        data: data.accounts.map(a => a.collected),
                        backgroundColor: colors.primary,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Accounts Target Chart
            const ctxTarget = document.getElementById('accountsTargetChart');
            if (accountsTargetChart) accountsTargetChart.destroy();
            const targetRates = data.accounts.map(a => Math.round((a.collected / a.target) * 100));
            accountsTargetChart = new Chart(ctxTarget, {
                type: 'bar',
                data: {
                    labels: data.accounts.map(a => a.name),
                    datasets: [{
                        label: 'نسبة التحقيق %',
                        data: targetRates,
                        backgroundColor: [colors.secondary, colors.primary, colors.accent],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            max: 100,
                            ticks: { suffix: '%' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Accounts Bar Chart
            const ctxBar = document.getElementById('accountsBarChart');
            if (accountsBarChart) accountsBarChart.destroy();
            accountsBarChart = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: data.accounts.map(a => a.name),
                    datasets: [
                        {
                            label: 'المفوتر',
                            data: data.accounts.map(a => a.invoiced),
                            backgroundColor: colors.accent,
                            borderRadius: 6
                        },
                        {
                            label: 'المحصل',
                            data: data.accounts.map(a => a.collected),
                            backgroundColor: colors.secondary,
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', align: 'end' }
                    },
                    scales: {
                        y: { beginAtZero: true },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function initTabsPage(data) {
            if (!data) data = DataService.getDummyData();
            const colors = getChartColors();
            
            // Populate tabs table
            const tbody = document.getElementById('tabsTableBody');
            tbody.innerHTML = data.tabs.map(tab => {
                const rate = Math.round((tab.collected / tab.invoiced) * 100);
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium">${tab.name}</td>
                        <td class="px-6 py-4 font-bold">${tab.collected.toLocaleString()} ر.س</td>
                        <td class="px-6 py-4">${tab.invoiced.toLocaleString()} ر.س</td>
                        <td class="px-6 py-4">${rate}%</td>
                        <td class="px-6 py-4">${tab.percentage}%</td>
                    </tr>
                `;
            }).join('');

            // Tabs Chart
            const ctx = document.getElementById('tabsChart');
            if (tabsChart) tabsChart.destroy();
            tabsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.tabs.map(t => t.name),
                    datasets: [{
                        data: data.tabs.map(t => t.collected),
                        backgroundColor: [colors.primary, colors.secondary, colors.accent, colors.red],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Tabs Bar Chart
            const ctxBar = document.getElementById('tabsBarChart');
            if (tabsBarChart) tabsBarChart.destroy();
            tabsBarChart = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: data.tabs.map(t => t.name),
                    datasets: [{
                        label: 'المحصل',
                        data: data.tabs.map(t => t.collected),
                        backgroundColor: [colors.primary, colors.secondary, colors.accent, colors.red],
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true },
                        y: { grid: { display: false } }
                    }
                }
            });

            // Tabs Monthly Chart
            const ctxMonthly = document.getElementById('tabsMonthlyChart');
            if (tabsMonthlyChart) tabsMonthlyChart.destroy();
            tabsMonthlyChart = new Chart(ctxMonthly, {
                type: 'line',
                data: {
                    labels: data.monthly.labels,
                    datasets: [
                        {
                            label: 'منتج',
                            data: [35000, 32000, 40000, 42000, 30000, 50000],
                            borderColor: colors.primary,
                            backgroundColor: colors.primary + '1A',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'خدمة',
                            data: [20000, 18000, 25000, 24000, 18000, 28000],
                            borderColor: colors.secondary,
                            backgroundColor: colors.secondary + '1A',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'استشارة',
                            data: [10000, 9000, 15000, 15000, 8000, 17000],
                            borderColor: colors.accent,
                            backgroundColor: colors.accent + '1A',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', align: 'end' }
                    },
                    scales: {
                        y: { beginAtZero: true },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function initComparisonPage(data) {
            if (!data) data = DataService.getDummyData();
            const colors = getChartColors();
            
            // Yearly table
            const tbody = document.getElementById('yearlyTableBody');
            tbody.innerHTML = data.yearly.map(y => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium">${y.year}</td>
                    <td class="px-6 py-4">${y.invoiced.toLocaleString()} ر.س</td>
                    <td class="px-6 py-4 font-bold">${y.collected.toLocaleString()} ر.س</td>
                    <td class="px-6 py-4">${y.target.toLocaleString()} ر.س</td>
                    <td class="px-6 py-4">${y.achievement}%</td>
                    <td class="px-6 py-4 text-green-600">+${y.growth}%</td>
                </tr>
            `).join('');

            // Comparison Chart
            const ctx = document.getElementById('comparisonChart');
            if (comparisonChart) comparisonChart.destroy();
            const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
            comparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: '2025',
                            data: [65, 59, 80, 81, 56, 95, 70, 75, 85, 90, 88, 92],
                            borderColor: colors.primary,
                            backgroundColor: colors.primary + '1A',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: '2024',
                            data: [55, 50, 70, 72, 48, 82, 60, 65, 75, 80, 78, 85],
                            borderColor: colors.secondary,
                            backgroundColor: colors.secondary + '1A',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', align: 'end' }
                    },
                    scales: {
                        y: { beginAtZero: true },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Target Comparison Chart
            const ctxTarget = document.getElementById('targetComparisonChart');
            if (targetComparisonChart) targetComparisonChart.destroy();
            targetComparisonChart = new Chart(ctxTarget, {
                type: 'bar',
                data: {
                    labels: months.slice(0, 6),
                    datasets: [
                        {
                            label: 'المستهدف',
                            data: [100, 100, 100, 100, 100, 100],
                            backgroundColor: colors.accent
                        },
                        {
                            label: 'الفعلي',
                            data: [65, 59, 80, 81, 56, 95],
                            backgroundColor: colors.primary
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', align: 'end' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function initDetailsPage(data) {
            if (!data) {
                console.warn('initDetailsPage: No data provided, trying to fetch...');
                // Try to fetch data if not provided
                const filters = getCurrentFilters();
                fetchRevenueDataCached(filters).then(fetchedData => {
                    if (fetchedData && fetchedData.details && fetchedData.details.length > 0) {
                        initDetailsPage(fetchedData);
                    } else {
                        console.warn('initDetailsPage: No data available, using dummy data');
                        initDetailsPage(DataService.getDummyData());
                    }
                }).catch(err => {
                    console.error('initDetailsPage: Error fetching data:', err);
                    initDetailsPage(DataService.getDummyData());
                });
                return;
            }
            
            console.log('initDetailsPage called with:', {
                hasData: !!data,
                detailsCount: data?.details?.length || 0,
                sampleDetail: data?.details?.[0]
            });
            
            const tbody = document.getElementById('detailsTableBody');
            if (!tbody) {
                console.error('initDetailsPage: detailsTableBody not found');
                return;
            }
            
            if (!data.details || data.details.length === 0) {
                console.warn('initDetailsPage: No details data available');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center gap-2">
                                <i class="ph ph-file-x text-4xl text-gray-400"></i>
                                <p class="font-medium">لا توجد بيانات للعرض</p>
                                <p class="text-sm">تأكد من:</p>
                                <ul class="text-sm text-right list-disc list-inside">
                                    <li>وجود ملف Excel في نفس المجلد (dashboard-data.xlsx)</li>
                                    <li>أن الملف يحتوي على بيانات</li>
                                    <li>تطبيق الفلاتر المناسبة</li>
                                </ul>
                                <button onclick="applyFilters()" class="mt-4 bg-blue-900 hover:bg-blue-800 text-white font-medium rounded-lg text-sm px-5 py-2.5 transition">
                                    <i class="ph ph-arrow-clockwise"></i> تحديث البيانات
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                // Update pagination text
                const paginationText = document.querySelector('#details .mt-4 .text-sm.text-gray-500, #details .text-sm.text-gray-400');
                if (paginationText) {
                    paginationText.textContent = 'عرض 0 من 0';
                }
                return;
            }
            
            tbody.innerHTML = data.details.map(d => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-6 py-4">${d.date}</td>
                    <td class="px-6 py-4">${d.year}</td>
                    <td class="px-6 py-4">${d.month}</td>
                    <td class="px-6 py-4">${d.account}</td>
                    <td class="px-6 py-4">${d.tab}</td>
                    <td class="px-6 py-4">${d.invoiced.toLocaleString()} ر.س</td>
                    <td class="px-6 py-4 font-bold">${d.collected.toLocaleString()} ر.س</td>
                </tr>
            `).join('');
            
            // Update pagination text
            const paginationText = document.querySelector('.mt-4 .text-sm.text-gray-500');
            if (paginationText) {
                const total = data.details.length;
                const showing = Math.min(10, total);
                paginationText.textContent = `عرض 1-${showing} من ${total}`;
            }
            
            console.log('initDetailsPage: Table populated with', data.details.length, 'rows');
        }

        function updateComparison() {
            initComparisonPage();
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            // Load saved theme
            loadSavedTheme();
            
            // Setup theme dropdown
            const themeToggleBtn = document.getElementById('themeToggleBtn');
            const themeDropdown = document.getElementById('themeDropdownMenu');
            
            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleThemeDropdown();
                });
            }
            
            // Setup theme option buttons
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const themeName = option.getAttribute('data-theme');
                    if (themeName) {
                        selectTheme(themeName);
                    }
                });
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                const container = document.getElementById('themeDropdownContainer');
                if (container && !container.contains(e.target)) {
                    if (themeDropdown) {
                        themeDropdown.classList.add('hidden');
                    }
                }
            });
            
            // Update dropdown UI with current theme
            const currentTheme = document.body.getAttribute('data-theme') || 'light';
            updateThemeDropdownUI(currentTheme);
            
            // Load user preferences
            loadUserPreferences();
            
            // Setup interactive features
            setupSearch();
            setupTableSorting();
            setupExport();
            setupRefresh();
            
            // Connect filter button
            document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
            
            // Initialize charts with Excel data
            try {
                const filters = getCurrentFilters();
                const initialData = await DataService.fetchRevenueData(filters);
                if (initialData) {
            initOverviewCharts(initialData);
            updateKPIs(initialData);
                    updateTables(initialData); // Update tables as well
                } else {
                    // Fallback to dummy data if Excel fails
                    const dummyData = DataService.getDummyData();
                    initOverviewCharts(dummyData);
                    updateKPIs(dummyData);
                    updateTables(dummyData);
                }
            } catch (error) {
                console.error('Error loading initial data:', error);
                // Fallback to dummy data
                const dummyData = DataService.getDummyData();
                initOverviewCharts(dummyData);
                updateKPIs(dummyData);
                updateTables(dummyData);
            }
            
            // Auto-refresh every 5 minutes (optional)
            // setInterval(() => {
            //     applyFilters();
            // }, 5 * 60 * 1000);
        });
    </script>
</body>
</html>